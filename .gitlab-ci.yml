stages:
  - build
  - run
  - deploy

variables:
  PROJECT_DIR: "nadinsoftTask"

# ğŸ§± Stage 1: Build Docker images
build:
  stage: build
  tags: [shell]
  script:
    - cd $PROJECT_DIR
    - echo "Building Docker images..."
    - docker compose build

# ğŸš€ Stage 2: Run services locally in CI
run:
  stage: run
  tags: [shell]
  script:
    - cd $PROJECT_DIR
    - echo "Starting services..."
    - docker compose up -d
    - docker compose ps
  when: on_success

# ğŸŒ Stage 3: Deploy to public server (same machine / VPS)
deploy:
  stage: deploy
  tags: [shell]
  script:
    - cd $PROJECT_DIR
    - echo "Deploying Flask app..."
    # Ø§Ú¯Ø± Ù‡Ù…ÛŒÙ† Runner Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ù¾Ø§Ø¨Ù„ÛŒÚ© ØªÙˆ Ù‡Ø³ØªØŒ Ù‡Ù…ÛŒÙ† compose Ú©Ø§ÙÛŒ Ø§Ø³Øª
    - docker compose down -v || true
    - docker compose up -d web
    - docker ps
    - echo "App deployed!"
    - echo "Now open: http://172.16.109.136:5000"
  environment:
    name: production
    url: http://172.16.109.136:5000
  only:
    - main
