stages:
  - build
  - run
  - deploy

variables:
  PROJECT_DIR: "nadinsoftTask"

build:
  stage: build
  tags:
    - shell
  script:
    - cd $PROJECT_DIR
    - echo "Building Docker images..."
    - docker compose build

run:
  stage: run
  tags:
    - shell
  script:
    - cd $PROJECT_DIR
    - echo "Starting services..."
    - docker compose up -d
    - docker compose ps
  when: on_success

deploy:
  stage: deploy
  tags:
    - shell
  script:
    - cd $PROJECT_DIR
    - echo "Deploying Flask app..."
    - docker compose down -v || true
    - docker compose up -d web
    - docker ps
    - echo "App deployed!"
  environment:
    name: production
    url: "http://172.16.109.136:5000"
  only:
    - main
