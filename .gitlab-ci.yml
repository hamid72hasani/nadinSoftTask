stages:
  - build
  - run
  - deploy

variables:
  PROJECT_DIR: "nadinsoftTask"

# 🧱 Stage 1: Build Docker images
build:
  stage: build
  tags: [shell]
  script:
    - cd $PROJECT_DIR
    - echo "Building Docker images..."
    - docker compose build

# 🚀 Stage 2: Run services locally in CI
run:
  stage: run
  tags: [shell]
  script:
    - cd $PROJECT_DIR
    - echo "Starting services..."
    - docker compose up -d
    - docker compose ps
  when: on_success

# 🌍 Stage 3: Deploy to public server (same machine / VPS)
deploy:
  stage: deploy
  tags: [shell]
  script:
    - cd $PROJECT_DIR
    - echo "Deploying Flask app..."
    # اگر همین Runner روی سرور پابلیک تو هست، همین compose کافی است
    - docker compose down -v || true
    - docker compose up -d web
    - docker ps
    - echo "App deployed!"
    - echo "Now open: http://172.16.109.136:5000"
  environment:
    name: production
    url: http://172.16.109.136:5000
  only:
    - main
