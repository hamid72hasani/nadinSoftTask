stages:
  - test
  - build
  - deploy

variables:
  # مسیر فولدر پروژه
  PROJECT_DIR: "$CI_PROJECT_DIR/nadinSoftTask"
  # تنظیمات لازم برای docker-in-docker
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: "tcp://docker:2375"

test:
  stage: test
  tags: ["docker"] 
  image: python:3.10
  script:
    # اگر requirements هست نصب می‌شود؛ در غیر اینصورت Flask نصب می‌شود
    - pip install -r "$PROJECT_DIR/requirements.txt" || pip install flask
    # اجرای تست‌ها از داخل فولدر پروژه
    - python -m unittest discover -s "$PROJECT_DIR" || echo "No tests yet"

build:
  stage: build
  tags: ["docker"] 
  image: docker:24.0
  services:
    - docker:24.0-dind
  script:
    # Build با context فولدر nadinSoftTask
    - docker build -t devops-task "$PROJECT_DIR"
    - docker images

deploy:
  stage: deploy
  tags: ["docker"] 
  image: docker:24.0
  services:
    - docker:24.0-dind
  script:
    - echo "Deploying to production..."
    # اگر docker compose v2 موجود باشد از این دستور استفاده می‌شود؛ در غیراینصورت از docker-compose
    - docker compose -f "$PROJECT_DIR/docker-compose.yml" up -d || docker-compose -f "$PROJECT_DIR/docker-compose.yml" up -d
